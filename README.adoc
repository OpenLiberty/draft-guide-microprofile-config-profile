// Copyright (c) 2023 IBM Corporation and others.
// Licensed under Creative Commons Attribution-NoDerivatives
// 4.0 International (CC BY-ND 4.0)
//   https://creativecommons.org/licenses/by-nd/4.0/
//
// Contributors:
//   IBM Corporation
:projectid: microprofile-config-profile
:page-layout: guide-multipane
:page-duration: 20 minutes
:page-releasedate: 2023-03-31
:page-description: Learn how to use MicroProfile Config's configuration profile feature to provide configurations for different phases in the DevOps lifecycle.
:page-tags: ['MicroProfile']
:page-permalink: /guides/{projectid}
:imagesdir: /img/guide/{projectid}
:page-related-guides: ['microprofile-config-intro', 'microprofile-config-apis']
:common-includes: https://raw.githubusercontent.com/OpenLiberty/guides-common/prod
:source-highlighter: prettify
:page-seo-title: Configuring Java microservices for multiple environments using MicroProfile Config
:page-seo-description: A tutorial and example on how to configure multiple project environments and development stages in DevOps lifecycle for Java microservices using MicroProfile Config's configuration profile feature.
:guide-author: Open Liberty
= Externalizing microservice configuration for continuous deployment in DevOps

[.hidden]
NOTE: This repository contains the guide documentation source. To view the guide in published form, view it on the https://openliberty.io/guides/{projectid}.html[Open Liberty website].

Learn how to create environment-specific configurations for microservices using MicroProfile Config's configuration profile feature for smoother management throughout the DevOps lifecycle.

:win: WINDOWS
:mac: MAC
:linux: LINUX

// =================================================================================================
// What you'll learn
// =================================================================================================
== What you'll learn

In the domain of software delivery, managing configurations for microservices can become complex, especially when configurations require adjustments across various stages. Continuous Deployment (CD) offers a solution by enabling the rapid and safe release of software changes. This practice is a significant component of the wider DevOps approach, which aims to refine the processes of software development and delivery.

MicroProfile Config's configuration profile feature, also known as the https://download.eclipse.org/microprofile/microprofile-config-3.0/microprofile-config-spec-3.0.html#configprofile[Config Profile^], is a direct solution to this challenge. It simplifies the management of microservice configurations across diverse environments -- from development to production and throughout the DevOps pipeline. By tailoring configuration properties to each environment, the deployment process becomes more seamless, allowing developers to concentrate on perfecting their application's delivery.

You'll learn how to provide environment-specific configurations using MicroProfile Config's configuration profile feature. You'll create configuration profiles at both the individual property and ConfigSource levels.

This guide builds on the basics of the https://openliberty.io/guides/microprofile-config-intro.html[Separating configuration from code in microservices^] guide and the https://openliberty.io/guides/microprofile-config.html[Configuring microservices^] guide. If you are not familiar with externalizing the configuration of microservices, it will be helpful to read https://openliberty.io/docs/latest/external-configuration.html[this document^] and complete those guides before proceeding.

The application that you will work with is a `query` service, which fetches information about the running JVM from a `system` microservice. Given the variances in accessing parameters between dev, test, and prod environments, you'll use the configuration profile feature to provide optimal configurations for these interactions.

image::system-query-devops.png[System and query services DevOps,align="center"]

// =================================================================================================
// Getting started
// =================================================================================================

[role=command]
include::{common-includes}/gitclone.adoc[]

// =================================================================================================
// Externalizing configuration properties in the default profile
// =================================================================================================
== Externalizing configuration properties in the default profile

When deploying microservices, configurations are typically set to default to production settings, ensuring the application runs optimally and securely if no specific profile is specified.

Navigate to the `start` directory to begin.

The starting Java project, which you can find in the `start` directory, is a multi-module Maven project that's made up of the `system` and `query` microservices. Each microservice resides in its own corresponding directory, `system` and `query`. The `system` microservice contains the three build profiles: `dev`, `test`, and `prod`. 

Start and deploy the `system` service to Open Liberty in the prod environment by running the following commands:

[role='command']
```
cd system
mvn -P prod liberty:run
```

// file 0
system/server.xml
[source, XML, linenums, role='code_column']
----
include::finish/system/src/main/liberty/config/server.xml[]
----

In the prod environment, the Liberty [hotspot file=0]`server.xml` provides the default configuration. The `system` service runs on port [hotspot=port file=0]`9080` using the context root [hotspot=context.root file=0]`system`. It uses a basic user registry with username [hotspot=username file=0]`admin` and password [hotspot=password file=0]`adminpwd` for resource authorization. Note that the `basicRegistry` element is a simple case for learning purposes. For more information on user registries, see the https://openliberty.io/docs/latest/user-registries-application-security.html[User registries documentation^].

Next, open another command-line session and run the following commands to navigate to the `query` directory and start the `query` service:

[role='command']
```
cd query
mvn liberty:run
```

// file 1
microprofile-config.properties
[source, properties, linenums, role="code_column hide_tags=development"]
----
include::finish/query/src/main/resources/META-INF/microprofile-config.properties[]
----

Navigate to the [hotspot=system file=1]`query/src/main/resources/META-INF/microprofile-config.properties` local configuration file to check the static configuration. This file is the default configuration source for an application using MicroProfile Config and contains the required properties to access the prod environment of the `system` service.

Point your browser to the http://localhost:9085/query/systems/localhost URL. You can see the current OS and Java version in JSON format. The URL retrieves the system property information for the `localhost` hostname by making a request to the `system` service at `\http://localhost:<system.httpPort>/<system.contextRoot>/property/{property}`.

After you finish checking out the application, stop the `system` service by pressing `CTRL+C` in the command-line session where you started the `system` service. Alternatively, you can run the `liberty:stop` goal from the `system` directory in another shell session:

[role='command']
```
mvn liberty:stop
```

// =================================================================================================
// Creating configuration profile for dev environment
// =================================================================================================
== Creating configuration profile for dev environment

In software development, it's best practice to maintain distinct configurations for dev and prod environments. The prod environments prioritize security and efficiency, while dev setups focus on debugging and flexibility.

MicroProfile Config's configuration profile feature allows for the supply of configurations for different environments while only a single profile is active. The active profile is set using the `mp.config.profile` property, which is a unique identifier for each configuration profile. This property can be set in any of the https://openliberty.io/guides/microprofile-config-intro.html#background-concepts[ConfigSources] or at application startup. Once set, the corresponding configuration properties associated with the active profile are used.

// file 0
system/pom.xml
[source, XML, linenums, role='code_column']
----
include::finish/system/pom.xml[]
----

When you run Open Liberty in dev mode, known as dev mode, dev mode listens for file changes and automatically recompiles and deploys your updates whenever you save a new change. Restart the `system` service in [hotspot=development file=0]`dev` environment by running the following Maven goal from the `system` directory:

[role='command']
```
mvn liberty:dev
```

After you see the following message, your Liberty instance is ready in dev mode:

[source, role="no_copy"]
----
**************************************************
*     Liberty is running in dev mode.
----

Dev mode holds your command-line session to listen for file changes. Open another command-line session to continue, or open the project in your editor.

Test the connection between the `query` service and the `system` service by pointing your browser to the http://localhost:9085/query/systems/localhost URL. The `query` service returns the message: `{"fail":"Failed to reach the client localhost."}`.

Given that the `system` service is currently undergoing development, the `query` service must now connect to it in the dev environment rather than the prod one.

image::system-query-devops-development.png[System service running in development environment,align="center"]

// =================================================================================================
// Configuring properties at property level
// =================================================================================================
=== Configuring properties at property level

Creating configuration profiles at the property level is useful when only a few configuration properties need to be set differently for each DevOps stage, such as when you require different database connection settings in different environments. 

To provide a configuration property for a particular config profile, use the `%<config_profile_id>.<property_name>=<value>` syntax, where `<config_profile_id>` is the unique identifier for the configuration profile and `<property_name>` is the name of the property you want to set.

[role="code_command hotspot file=0", subs="quotes"]
----
#Replace the `microprofile-config.properties` file.#
`query/src/main/resources/META-INF/microprofile-config.properties`
----

// file 0
microprofile-config.properties
[source, properties, linenums, role="code_column"]
----
include::finish/query/src/main/resources/META-INF/microprofile-config.properties[]
----

// file 1
system/pom.xml
[source, XML, linenums, role='code_column']
----
include::finish/system/pom.xml[]
----

Configure the [hotspot=development file=0]`%dev.*` properties in the `microprofile-config.properties` file based on the values from the [hotspot=developmentProperties file=1]`dev` profile of the `system` service.

Once you have updated the properties, stop the `query` service by pressing `CTRL+C` in the command-line session where you started the `query` service. Alternatively, you can run the `liberty:stop` goal from the `query` directory in another shell session:

[role='command']
```
mvn liberty:stop
```

After stopping the `query` service, restart it with the `dev` configuration profile by running the following Maven goal from the `query` directory:

[role='command']
```
mvn liberty:dev -Dliberty.var.mp.config.profile="dev"
```

After you see the following message, your Liberty instance is ready in dev mode:

[source, role="no_copy"]
----
**************************************************
*     Liberty is running in dev mode.
----

Dev mode holds your command-line session to listen for file changes. Open another command-line session to continue, or open the project in your editor.

By setting `mp.config.profile` to `dev` as a Liberty variable, each `%dev.*` property will override the value of its original property. For example, the [hotspot=dev.port file=0]`%dev.system.httpPort` property will override the [hotspot=port file=0]`system.httpPort` property and the value will be resolved to `9081` in this case.

After restarting the `query` service with the `dev` configuration profile, you can now access the application by using the http://localhost:9085/query/systems/localhost URL. You can see the current OS and Java version in JSON format.

// =================================================================================================
// Configuring properties at ConfigSource level
// =================================================================================================
=== Configuring properties at ConfigSource level

In addition to creating configuration profiles at the property level, it's also possible to create configuration profiles using ConfigSources. This can be particularly useful when you need to manage a large number of configuration properties for different environments. For instance, each DevOps stage may require the application to run on different ports and context roots. Using a ConfigSource to externalize and customize these configurations leads to a cleaner and more modular code design.

To create a configuration profile at the ConfigSource level, simply create a file under the `META-INF` folder on the classpath with the naming convention `microprofile-config-<config_profile_id>.properties`, where `<config_profile_id>` is the unique identifier for the configuration profile. Once you have created the file, you can add your configuration properties to it with the `<property_name>=<value>` syntax. 

In this example, you will provide configuration properties for the `dev` environment to the `query` service using a ConfigSource properties file.

// file 0
[role="code_command hotspot file=0", subs="quotes"]
----
#Create the `microprofile-config-dev.properties` file.#
`query/src/main/resources/META-INF/microprofile-config-dev.properties`
----

/microprofile-config-dev.properties
[source, properties, linenums, role="code_column hide_tags=userPassword,properties,contactEmail,roleAndQuery"]
----
include::finish/query/src/main/resources/META-INF/microprofile-config-dev.properties[]
----

// file 1
system/pom.xml
[source, XML, linenums, role='code_column']
----
include::finish/system/pom.xml[]
----

Define the [hotspot=system file=0]`system.*` properties in the `microprofile-config-dev.properties` file based on the values from the [hotspot=developmentProperties file=1]`dev` profile of the `system` service.

// file 2
[role="code_command hotspot file=2", subs="quotes"]
----
#Replace the `microprofile-config.properties` file.#
`query/src/main/resources/META-INF/microprofile-config.properties`
----

microprofile-config.properties
[source, properties, linenums, role="code_column hide_tags=development"]
----
include::finish/query/src/main/resources/META-INF/microprofile-config.properties[]
----

// file 3
system/server.xml
[source, XML, linenums, role='code_column']
----
include::finish/system/src/main/liberty/config/server.xml[]
----

Remove the `%dev.*` properties from the `microprofile-config.properties` file.

Since the active profile is set to `dev`, the [hotspot file=0]`microprofile-config-dev.properties` file is loaded on top of the default [hotspot file=2]`microprofile-config.properties` file. Any `system.*` properties specified in the former thus take precedence over the values in the latter.

Because you are running the `query` service in dev mode, the changes that you made were automatically picked up. Point your browser to the http://localhost:9085/query/systems/localhost URL to check out the application again. You see the current OS and Java version in JSON format.

When you are done checking out the application in `dev` environment, exit dev mode by pressing `CTRL+C` in the command-line sessions where you ran the `system` and `query` services, or by typing `q` and then pressing the `enter/return` key. 

// =================================================================================================
// Creating configuration profile for test environment
// =================================================================================================
== Creating configuration profile for test environment

In DevOps, the test environment is where integration tests come to life, checking software readiness. Proper testing configuration not only ensures smooth operations but also aligns the environment closer to potential production settings.

// file 0
[role="code_command hotspot file=0", subs="quotes"]
----
#Create the `microprofile-config-test.properties` file.#
`query/src/main/resources/META-INF/microprofile-config-test.properties`
----

microprofile-config-test.properties
[source, properties, linenums, role="code_column"]
----
include::finish/query/src/main/resources/META-INF/microprofile-config-test.properties[]
----

// file 1
system/pom.xml
[source, XML, linenums, role='code_column']
----
include::finish/system/pom.xml[]
----

Define the [hotspot=system file=0]`system.*` properties in the `microprofile-config-test.properties` file based on the values from the [hotspot=developmentProperties file=1]`test` profile of the `system` service.

// file 2
[role="code_command hotspot file=2", subs="quotes"]
----
#Create the `QueryEndpointIT` class.#
`query/src/test/java/it/io/openliberty/guides/query/QueryEndpointIT.java`
----

QueryEndpointIT.java
[source, java, linenums, role="code_column hide_tags=copyright"]
----
include::finish/query/src/test/java/it/io/openliberty/guides/query/QueryEndpointIT.java[]
----

Implement endpoint tests to test the basic functionality of the `query` microservice. If a test failure occurs, then you might have introduced a bug into the code.

See the following descriptions of the test cases:

* [hotspot=testQuerySystem file=2]`testQuerySystem()` verifies the `/query/systems/{hostname}` endpoint.

* [hotspot=testUnknownHost file=2]`testUnknownHost()` verifies that an unknown host or a host that does not expose their JVM system properties is correctly handled with a fail message.

=== Running the tests in the test environment

Now, navigate to the `start` directory.

// file 0
scripts/testApp.sh|.bat
[source, XML, linenums, role='code_column']
----
include::finish/scripts/testApp.sh[]
----

// file 1
microprofile-config-test.properties
[source, properties, linenums, role="code_column"]
----
include::finish/query/src/main/resources/META-INF/microprofile-config-test.properties[]
----

Test the application under the test environment by running the following script that contains different Maven goals to [hotspot=build file=0]`build`, [hotspot=start file=0]`start`, [hotspot=test file=0]`test`, and [hotspot=stop file=0]`stop` the services.

include::{common-includes}/os-tabs.adoc[]

[.tab_content.mac_section.linux_section]
--
[role='command']
```
./scripts/testApp.sh
```
--

[.tab_content.windows_section]
--
[role='command']
```
scripts\testApp.bat
```
--

If the tests pass, you see output similar to the following example:

[source, role="no_copy"]
----
-------------------------------------------------------
 T E S T S
-------------------------------------------------------
Running it.io.openliberty.guides.system.SystemEndpointIT
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.539 s - in it.io.openliberty.guides.system.SystemEndpointIT

Results:

Tests run: 1, Failures: 0, Errors: 0, Skipped: 0

...

-------------------------------------------------------
 T E S T S
-------------------------------------------------------
Running it.io.openliberty.guides.query.QueryEndpointIT
Tests run: 2, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 1.706 s - in it.io.openliberty.guides.query.QueryEndpointIT

Results:

Tests run: 2, Failures: 0, Errors: 0, Skipped: 0

----

== Great work! You're done!

You just learned how to use the MicroProfile Config's configuration profile feature to configure your application for multiple DevOps environments.

Feel free to try one of the related guides. They demonstrate new technologies that you can learn to expand on what you built in this guide.

include::{common-includes}/attribution.adoc[subs="attributes"]
